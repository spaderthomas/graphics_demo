local DEFAULT_FRAME_TIME = 8 / 60

Animation = tdengine.component('Animation')
function Animation:load(data)
   self.animations = data.animations or {}
   self:batch_add(self.xnimations)

   self.current = ''
   local current = data.current or nil
   if current then
	  self.current = current
	  self:begin(self.current)
   end
end

-- Some entities need to save out their animation table, because they are built
-- at runtime. This is the equivalent of Animation:save, except we can't call it
-- that, because that would automatically opt-in the component to serialization
function Animation:as_table()
   return {
	  animations = self.animations,
	  current = self.current
   }
end

function Animation:init()
   self.frame = 0
   self.time_to_next = DEFAULT_FRAME_TIME
end

function Animation:update(dt)
   self.time_to_next = self.time_to_next - dt
   if self.time_to_next <= 0 then
	  self:advance_frame()
	  self.time_to_next = DEFAULT_FRAME_TIME
   end
end

function Animation:add(name, frames)
   tdengine.register_animation(name, frames)
end

function Animation:batch_add(animations)
   for name, frames in pairs(animations) do
	  tdengine.register_animation(name, frames)
   end
end

function Animation:begin(name)
   self.current = name
end

function Animation:advance_frame()
   local frames = tdengine.get_frames(self.current)
   self.frame = (self.frame + 1) % #frames
   self.time_to_next = DEFAULT_FRAME_TIME
end
